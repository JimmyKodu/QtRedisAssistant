name: Build and Release

on:
  push:
    branches: [ main, master, develop, copilot/** ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgl1-mesa-dev
    
    - name: Build
      run: |
        mkdir -p build
        cd build
        cmake ..
        cmake --build . --config Release
    
    - name: Get version
      id: version
      run: |
        VERSION=$(grep "project.*VERSION" CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Package Linux executable
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        mkdir -p "releases/v${VERSION}/linux"
        cp build/QtRedisAssistant "releases/v${VERSION}/linux/"
        
        # Create a simple run script
        cat > "releases/v${VERSION}/linux/run.sh" << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}:${LD_LIBRARY_PATH}"
        "${SCRIPT_DIR}/QtRedisAssistant" "$@"
        EOF
        chmod +x "releases/v${VERSION}/linux/run.sh"
        chmod +x "releases/v${VERSION}/linux/QtRedisAssistant"
        
        # Create README
        cat > "releases/v${VERSION}/linux/README.txt" << EOF
        Qt Redis Assistant v${VERSION} - Linux Build
        =============================================
        
        Built on: $(date)
        Platform: Linux (Ubuntu 22.04)
        Qt Version: 6.5.3
        
        To run:
        ./run.sh
        
        or directly:
        ./QtRedisAssistant
        
        Note: Ensure Qt libraries are in your LD_LIBRARY_PATH or install Qt6 on your system.
        EOF
        
        # Show files
        ls -lh "releases/v${VERSION}/linux/"
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: QtRedisAssistant-Linux-v${{ steps.version.outputs.VERSION }}
        path: releases/v${{ steps.version.outputs.VERSION }}/linux/
        retention-days: 90

  build-windows:
    runs-on: windows-2022
    permissions:
      contents: read
    
    env:
      QT_VERSION: '6.5.3'
      MINGW_TOOLS: 'tools_mingw90'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        modules: 'qtnetworkauth'
        cache: true
        tools: ${{ env.MINGW_TOOLS }}
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
    
    - name: Get version
      id: version
      shell: bash
      run: |
        VERSION=$(grep "project.*VERSION" CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Package Windows executable
      shell: bash
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        mkdir -p "releases/v${VERSION}/windows"
        
        # Make deployment script executable
        chmod +x deploy_windows.sh
        
        # Run deployment script to copy all dependencies
        ./deploy_windows.sh build/QtRedisAssistant.exe "releases/v${VERSION}/windows"
        
        # Create README
        cat > "releases/v${VERSION}/windows/README.txt" << EOF
Qt Redis Assistant v${VERSION} - Windows Build (Self-Contained)
================================================================

Built on: $(date)
Platform: Windows (Server 2022)
Qt Version: ${{ env.QT_VERSION }}
Compiler: MinGW (from ${{ env.MINGW_TOOLS }})

This is a self-contained release that includes all required dependencies:
- Qt6 runtime libraries (Qt6Core.dll, Qt6Gui.dll, Qt6Widgets.dll, Qt6Network.dll)
- MinGW runtime libraries (libgcc_s_seh-1.dll, libstdc++-6.dll, libwinpthread-1.dll)
- Qt platform plugins (platforms/qwindows.dll)
- Qt configuration file (qt.conf)

To run:
1. Double-click QtRedisAssistant.exe

Or from command line:
2. QtRedisAssistant.exe

No additional Qt or MinGW installation is required on the target system.
All necessary DLLs are included in this directory.

================================================================================
⚠️  IMPORTANT WARNING - 重要警告  ⚠️
================================================================================

DO NOT copy DLL files from other applications (such as Wireshark, Notepad++, or 
other Qt applications) to fix missing DLL errors!

绝对不要从其他应用程序（如 Wireshark、Notepad++ 或其他 Qt 应用）复制 DLL 文件
来修复缺少 DLL 的错误！

Different applications use different Qt versions and compilers. Mixing DLLs 
will cause errors like:
- "Unable to locate program entry point _Z9qBadAllocv"
- Random crashes and undefined behavior

不同的应用程序使用不同的 Qt 版本和编译器。混合使用 DLL 会导致错误，例如：
- "无法定位程序输入点 _Z9qBadAllocv"
- 随机崩溃和未定义行为

If you see missing DLL errors, re-download this complete package from GitHub 
Actions or build from source using the correct Qt version.

如果您看到缺少 DLL 的错误，请从 GitHub Actions 重新下载完整包，或使用正确的 
Qt 版本从源代码构建。

For detailed instructions, see:
https://github.com/${{ github.repository }}/blob/main/README_WINDOWS.md

详细说明请参阅：
https://github.com/${{ github.repository }}/blob/main/README_WINDOWS.md
================================================================================
EOF
        
        # Show files
        echo "Files in Windows release directory:"
        ls -lh "releases/v${VERSION}/windows/"
        echo ""
        echo "Platform plugins:"
        ls -lh "releases/v${VERSION}/windows/platforms/" || echo "No platform plugins directory"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: QtRedisAssistant-Windows-v${{ steps.version.outputs.VERSION }}
        path: releases/v${{ steps.version.outputs.VERSION }}/windows/
        retention-days: 90

  create-release-structure:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version
      id: version
      run: |
        VERSION=$(grep "project.*VERSION" CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: QtRedisAssistant-Linux-v${{ steps.version.outputs.VERSION }}
        path: releases/v${{ steps.version.outputs.VERSION }}/linux/
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: QtRedisAssistant-Windows-v${{ steps.version.outputs.VERSION }}
        path: releases/v${{ steps.version.outputs.VERSION }}/windows/
    
    - name: Create release summary
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        cat > "releases/v${VERSION}/BUILD_INFO.txt" << EOF
        Qt Redis Assistant v${VERSION}
        ===============================
        
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${GITHUB_SHA:0:7}
        Git Branch: ${GITHUB_REF#refs/heads/}
        
        This release contains executables for:
        - Linux (linux/)
        - Windows (windows/)
        
        Both builds have been tested and verified to compile successfully.
        EOF
        
        echo "Release structure created:"
        tree releases/ || find releases/ -type f
    
    - name: Upload combined release
      uses: actions/upload-artifact@v4
      with:
        name: QtRedisAssistant-All-Platforms-v${{ steps.version.outputs.VERSION }}
        path: releases/
        retention-days: 90
